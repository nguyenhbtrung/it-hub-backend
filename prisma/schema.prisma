// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// =====================================================
// ENUMS
// =====================================================
enum UserRole {
  admin
  instructor
  student
}

enum UserScope {
  internal
  external
}

enum UserStatus {
  active
  suspended
}

enum CourseLevel {
  beginner
  intermediate
  advanced
  expert
}

enum CourseEnrollmentStatus {
  public
  public_with_approval
  internal
  private
}

enum CourseStatus {
  draft
  pending
  published
  hidden
  suspended
}

enum EnrollmentStatus {
  pending
  active
  completed
}

enum UnitType {
  lesson
  excercise
}

enum ExcerciseType {
  assignment
  project
  quiz
  coding
}

enum LearningStatus {
  not_started
  completed
  submitted
  not_passed
}

enum PostType {
  question
  knowledge
  discussion
  experience
  news
  resource
  announcement
}

enum PostStatus {
  draft
  pending
  active
  hidden
  suspended
}

enum FileStatus {
  unused
  temporary
  active
}

// =====================================================
// USER DOMAIN
// =====================================================
model User {
  id            String     @id @default(cuid())
  email         String     @unique
  passwordHash  String
  fullname      String?
  role          UserRole
  scope         UserScope
  status        UserStatus @default(active)
  emailVerified Boolean    @default(false)
  instructorApplicationAt DateTime?

  avatarId      String?
  avatar        File?      @relation(name: "UserAvatar", fields: [avatarId], references: [id], onDelete: SetNull) 

  profile       UserProfile?
  badges        UserBadge[]
  files         File[] @relation("OwnerFile")
  followers     UserFollow[] @relation("Followers")
  following     UserFollow[] @relation("Following")
  tagFollows    TagFollow[]
  courses       Course[]
  reviews       Review[]
  enrollments   Enrollment[]
  courseLastAccess   CourseLastAccess[]
  savedCourses  SavedCourse[]
  excerciseAttempts ExcerciseAttempt[]
  learningProgress LearningProgress[]
  posts         Post[]
  comments      Comment[]
  votes         Vote[]
  savedPosts    SavedPost[]
  refreshTokens RefreshToken[]
  verificationToken VerificationToken?
  passwordResetToken PasswordResetToken?

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([role])
  @@index([scope])
  @@index([status])
  @@map("users")
}

model UserProfile {
  userId          String   @id
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  bio             String?
  school          String?
  specialized     String?
  githubUrl       String?
  linkedinUrl     String?
  websiteUrl      String?
  skill           Json?
  reputationPoint Int      @default(0)

  updatedAt       DateTime @updatedAt

  @@map("user_profiles")
}

model Badge {
  id          String @id @default(cuid())
  name        String
  description String
  icon        String

  userBadges UserBadge[]

  @@map("badges")
}

model UserBadge {
  userId    String
  badgeId  String
  awardedAt DateTime @default(now())

  user   User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@id([userId, badgeId])
  @@map("user_badges")
}

model UserFollow {
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade) 
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade) 

  @@id([followerId, followingId])
  @@map("user_follows")
}

// =====================================================
// FILE & TAXONOMY DOMAIN
// =====================================================
model File {
  id       String @id @default(cuid())
  name     String
  url      String
  type     String
  size     BigInt
  mimeType String
  extension String
  status   FileStatus
  metadata Json

  providerPublicId  String?
  provider          String @default("local")


  ownerId   String
  owner     User @relation("OwnerFile", fields: [ownerId], references: [id], onDelete: Cascade)

  userAvatars   User[] @relation("UserAvatar")
  courseImages  Course[] @relation("CourseImage")
  coursePromoVideos Course[] @relation("CoursePromoVideo")
  materials     Material[]
  excerciseAttachments ExcerciseAttachment[]
  postAttachments PostAttachment[]
  fileUsages FileUsage[]

  createdAt     DateTime   @default(now())
  deletedAt     DateTime?

  @@map("files")
}

model FileUsage {
  id       String @id @default(cuid())

  fileId   String @unique
  file     File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  stepId   String?
  step     Step? @relation(fields: [stepId], references: [id], onDelete: SetNull)

  exerciseId   String?
  exercise     Excercise? @relation(fields: [exerciseId], references: [id], onDelete: SetNull)
  @@map("file_usages")
}

model Category {
  id          String     @id @default(cuid())
  parentId    String?
  parent      Category? @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryTree")

  name        String
  slug        String     @unique
  description String?

  courses     Course[] @relation("CourseCategory")
  subCategoryCourses Course[] @relation("CourseSubCategory")

  @@index([parentId])
  @@map("categories")
}

model Tag {
  id          String @id @default(cuid())
  name        String
  slug        String @unique
  description String?

  follows     TagFollow[]
  courseTags  CourseTag[]
  postTags    PostTag[]

  @@map("tags")
}

model TagFollow {
  userId String
  tagId  String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade) 
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade) 

  @@id([userId, tagId])
  @@map("tag_follows")
}

// =====================================================
// COURSE DOMAIN
// =====================================================
model Course {
  id               String @id @default(cuid())
  instructorId     String
  categoryId       String
  subCategoryId    String?

  instructor       User     @relation(fields: [instructorId], references: [id], onDelete: Restrict) 
  category         Category @relation("CourseCategory", fields: [categoryId], references: [id], onDelete: Restrict) 
  subCategory      Category? @relation("CourseSubCategory", fields: [subCategoryId], references: [id], onDelete: SetNull) 

  title            String
  slug             String   @unique
  shortDescription String
  description      Json
  level            CourseLevel

  imgId            String?
  promoVideoId     String?
  img              File?    @relation("CourseImage", fields: [imgId], references: [id], onDelete: SetNull)
  promoVideo       File?    @relation("CoursePromoVideo", fields: [promoVideoId], references: [id], onDelete: SetNull)

  totalDuration    Int
  avgRating        Float    @default(0)
  reviewCount      Int      @default(0)

  enrollmentStatus CourseEnrollmentStatus
  status           CourseStatus

  requirements     Json
  keyTakeaway      Json

  tags             CourseTag[]
  reviews          Review[]
  enrollments      Enrollment[]
  courseLastAccess      CourseLastAccess[]
  savedCourses     SavedCourse[]
  sections         Section[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([instructorId])
  @@index([categoryId])
  @@index([status])
  @@map("courses")
}

model CourseTag {
  courseId String
  tagId    String

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([courseId, tagId])
  @@map("course_tags")
}

model Review {
  courseId String
  userId   String
  rating   Int
  comment  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade) 
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([courseId, userId])
  @@map("reviews")
}

model Enrollment {
  courseId  String
  userId    String
  status    EnrollmentStatus
  enrolledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade) 
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([courseId, userId])
  @@map("enrollments")
}

model CourseLastAccess {
  courseId    String
  userId      String
  stepId      String?
  unitId      String?
  sectionId   String?

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade) 
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  step  Step?   @relation(fields: [stepId], references: [id], onDelete: SetNull)
  unit  Unit?   @relation(fields: [unitId], references: [id], onDelete: SetNull)
  section  Section?   @relation(fields: [sectionId], references: [id], onDelete: SetNull)

  accessAt DateTime @default(now())

  @@id([courseId, userId])
  @@map("course_last_access")
}

model SavedCourse {
  courseId String
  userId   String
  createdAt DateTime @default(now())

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade) 
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([courseId, userId])
  @@map("saved_courses")
}

// =====================================================
// LEARNING STRUCTURE DOMAIN
// =====================================================
model Section {
  id          String @id @default(cuid())
  courseId    String
  title       String
  description String
  objectives  Json
  order       Int

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  units  Unit[]
  courseLastAccess CourseLastAccess[]

  @@index([courseId])
  @@map("sections")
}

model Unit {
  id          String @id @default(cuid())
  sectionId   String
  type        UnitType
  title       String
  description String?
  order       Int

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  steps   Step[]
  excercises Excercise[]
  materials Material[]
  courseLastAccess CourseLastAccess[]

  @@index([sectionId])
  @@map("units")
}

model Step {
  id       String @id @default(cuid())
  lessonId String
  title    String
  content  Json
  order    Int
  duration Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lesson Unit @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  learningProgress LearningProgress[]
  courseLastAccess CourseLastAccess[]
  fileUsages FileUsage[]
  stepEmbeddings StepEmbedding[]

  @@index([lessonId])
  @@map("steps")
}

model Excercise {
  id           String @id @default(cuid())
  unitId       String
  type         ExcerciseType
  title        String
  description  String
  content      Json
  deadline     DateTime?
  duration     Int?
  passingScore Float?

  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade) 
  excerciseQuizzes ExcerciseQuiz[]
  attempts ExcerciseAttempt[]
  learningProgress LearningProgress[]
  fileUsages FileUsage[]

  @@index([unitId])
  @@map("excercises")
}

model Material {
  id        String @id @default(cuid())
  unitId    String
  fileId    String
  createdAt DateTime @default(now())

  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade) 
  file File @relation(fields: [fileId], references: [id], onDelete: Cascade) 

  @@map("materials")
}

// =====================================================
// QUIZ & ATTEMPT DOMAIN
// =====================================================
model Quiz {
  id           String @id @default(cuid())
  question     Json
  options      Json
  explaination Json?

  excerciseQuizzes ExcerciseQuiz[]

  @@map("quizzes")
}

model ExcerciseQuiz {
  id          String @id @default(cuid())
  excerciseId String
  quizId      String

  excercise Excercise @relation(fields: [excerciseId], references: [id], onDelete: Cascade)
  quiz      Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade) 

  @@map("excercise_quizzes")
}

model ExcerciseAttempt {
  id          String @id @default(cuid())
  excerciseId String
  studentId   String
  score       Float?
  comment     String?
  quizResults Json?
  demoUrl     Json?
  note        String?
  createdAt DateTime @default(now())

  excercise Excercise @relation(fields: [excerciseId], references: [id], onDelete: Cascade) 
  student   User      @relation(fields: [studentId], references: [id], onDelete: Cascade) 
  attachments ExcerciseAttachment[]

  @@index([studentId])
  @@map("excercise_attempts")
}

model ExcerciseAttachment {
  id       String @id @default(cuid())
  attemptId String
  fileId   String

  attempt ExcerciseAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade) 
  file    File             @relation(fields: [fileId], references: [id], onDelete: Cascade) 

  @@map("excercise_attachments")
}

model LearningProgress {
  id          String @id @default(cuid())
  studentId   String
  stepId      String?
  excerciseId String?
  status      LearningStatus
  updatedAt   DateTime @updatedAt

  student   User      @relation(fields: [studentId], references: [id], onDelete: Cascade) 
  step      Step?     @relation(fields: [stepId], references: [id], onDelete: Cascade) 
  excercise Excercise? @relation(fields: [excerciseId], references: [id], onDelete: Cascade) 

  @@unique([studentId, stepId])
  @@unique([studentId, excerciseId])
  @@map("learning_progress")
}

// =====================================================
// FORUM DOMAIN
// =====================================================
model Post {
  id        String @id @default(cuid())
  userId    String
  title     String
  slug      String @unique
  content   Json
  type      PostType
  status    PostStatus
  views     Int @default(0)
  upvotes   Int @default(0)
  downvotes Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade) 
  attachments PostAttachment[]
  tags PostTag[]
  savedPosts SavedPost[]
  comments Comment[]
  votes Vote[]

  @@index([type])
  @@index([status])
  @@map("posts")
}

model PostAttachment {
  id     String @id @default(cuid())
  postId String
  fileId String

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade) 
  file File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@map("post_attachments")
}

model PostTag {
  postId String
  tagId  String

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade) 
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade) 

  @@id([postId, tagId])
  @@map("post_tags")
}

model SavedPost {
  postId String
  userId String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade) 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade) 

  @@id([postId, userId])
  @@map("saved_posts")
}

model Comment {
  id        String @id @default(cuid())
  userId    String?
  postId    String
  parentId  String?
  content   Json
  isAccepted Boolean @default(false)
  upvotes   Int @default(0)
  downvotes Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User?     @relation(fields: [userId], references: [id], onDelete: SetNull) 
  post     Post     @relation(fields: [postId], references: [id], onDelete: Cascade) 
  parent   Comment? @relation("CommentTree", fields: [parentId], references: [id], onDelete: Cascade)
  children Comment[] @relation("CommentTree")
  votes    Vote[]

  @@index([postId])
  @@map("comments")
}

model Vote {
  id        String @id @default(cuid())
  userId    String
  postId    String?
  commentId String?
  isUpvote  Boolean
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade) 
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade) 
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@map("votes")
}

// =====================================================
// TOKENS
// =====================================================
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("refresh_tokens")
}

model VerificationToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade) 
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade) 
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("password_reset_tokens")
}

model StepEmbedding {
  id        String @id @default(cuid())
  stepId    String

  courseId  String?
  sectionId String?
  unitId    String?

  chunkIndex  Int
  content     String
  embedding Unsupported("vector")?

  step      Step                   @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([sectionId])
  @@index([unitId])
  @@map("step_embeddings")
}